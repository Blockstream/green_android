stages:
    - format
    - build
    - test

build_release_iphone:
  stage: build
  tags:
    - osx
  script:
    - cd $CI_PROJECT_DIR
    - ./tools/build.sh --update-cocoapods --iphone static

build_tag_release_export:
  stage: build
  when: manual
  artifacts:
    name: "green-ios-release-$CI_COMMIT_REF_NAME"
    expire_in: 1 day
    when: on_success
    paths:
      - build/Green.ipa
  tags:
    - fastosx
    - osx
  script:
    - cd $CI_PROJECT_DIR
    - ./tools/build.sh --build-gdk --sign-and-export --update-cocoapods --iphone static

test_format:
  stage: format
  tags:
    - fastosx
    - osx
  script:
    - fastlane run swiftlint

build_debug:
  stage: build
  tags:
    - fastosx
    - osx
  script:
    - fastlane build_debug

ui_tests:
  stage: test
  tags:
    - osx
  when: manual
  needs: ["build_release_iphone"]
  before_script:
    - xcrun simctl boot "iPhone 11"
    - xcrun simctl privacy "iPhone 11" grant all io.blockstream.green
  script:
    - cd $CI_PROJECT_DIR
    - export LC_ALL=en_US.UTF-8
    - export LANG=en_US.UTF-8
    - ./tools/fetch_gdk_binaries.sh --simulator
    - pod install
    - fastlane ui_tests
  after_script:
    - xcrun simctl shutdown "iPhone 11"
